# 【回答】クッキーを理解する。

課題については、Airtable にアクセスして頂き、「クッキーを理解する」をご確認願います。 https://airtable.com/tblg8ePOEQRDtIGiY/viwV3pAlEvPOOgmHF?blocks=hide

## 課題 1 の回答

## クッキーとは

Cookie は、サーバーがユーザーのウェブブラウザーに送信する小さなデータであり、ブラウザーに保存され、その後のリクエストと共に同じサーバーへ返送されます。一般的には、二つのリクエストが同じブラウザーから送信されたものであるかを知るために使用されます。例えば、ユーザーのログイン状態を維持することができます。Cookie は、ステートレスな HTTP プロトコルのためにステートフルな情報を記憶します。

HTTP リクエストを受け取った後、サーバーはレスポンスで Set-Cookie ヘッダーを送信することができます。通常 Cookie はブラウザに保存され、また Cookie は同じサーバーに対して行われるリクエストと共に HTTP の Cookie ヘッダーの中で送信されます。有効期限や期間を設定することができ、その後は Cookie が送信されなくなります。特定のドメインやパスへの追加の制約を設定することができ、Cookie をどこに送信するかを制限することができます。

## www.hoge.comで発行されたクッキーは、www.fuga.comにも送信されるか？

- 回答

送信できる。

- 回答根拠

リクエストは送信できる。
ただし、同一オリジンポリシーに基づき、レスポンスはスクリプトが読み取らないため受信できない。

回答の根拠に関して、以下のとおり用語を整理する。

### Cookie とは

HTTP Cookie (ウェブ Cookie、ブラウザー Cookie) は、サーバーがユーザーのウェブブラウザーに送信する小さなデータであり、ブラウザーに保存され、その後のリクエストと共に同じサーバーへ返送されます。一般的には、二つのリクエストが同じブラウザーから送信されたものであるかを知るために使用されます。例えば、ユーザーのログイン状態を維持することができます。Cookie は、ステートレスな HTTP プロトコルのためにステートフルな情報を記憶します。

### 同一オリジンポリシーとは

同一オリジンポリシーとは、あるオリジンから読み込まれた文書やスクリプトについて、そのリソースから他のオリジンのリソースにアクセスできないように制限するものです。

### オリジンとは

二つのページのプロトコル、ポート番号 (もしあれば)、ホストが等しい場合、両者のページは同じオリジンです。これは「スキーム/ホスト/ポート番号のタプル」または時に単に「タプル」として参照されます (「タプル」は共に全体を構成する三つの部分の組み合わせを表します)。

### Cookie の送信先の定義

Domain および Path 属性は、Cookie のスコープ、つまり Cookie を送信する対象の URL を定義します。

- Domain 属性

Domain 属性は、Cookie を受信することができるホストを指定します。指定されていない場合は、既定でクッキーを設定したのと同じオリジンとなり、サブドメインは除外されます。 Domain が指定された場合、サブドメインは常に含まれます。したがって、 Domain を指定すると省略時よりも制限が緩和されます。ただし、サブドメイン間でユーザーに関する情報を共有する場合は有用になるでしょう。

例えば、Domain=mozilla.org を設定すると、developer.mozilla.org のようなサブドメインも含まれます。

- Path 属性

Path 属性は、 Cookie ヘッダーを送信するためにリクエストされた URL の中に含む必要がある URL のパスを示します。 %x2F ("/") の文字はディレクトリ区切り文字として解釈され、サブディレクトリにも同様に一致します。

例えば、Path=/docs を設定すると、以下のパスに一致します。

/docs

/docs/Web/

/docs/Web/HTTP

- SameSite 属性

SameSite 属性により、サーバーがオリジン間リクエスト (ここでサイトは登録可能なドメインによって定義されます) と一緒にクッキーを送るべきではないことを要求することができます。これは、クロスサイトリクエストフォージェリ攻撃 (CSRF) に対していくらかの防御となります。

取ることができる値は Strict, Lax, None の 3 つです。 Strict では、クッキーはそれが発生したものと同じサイトに対してのみ送信されます。 Lax も似ていますが、ユーザーがリンクをたどるなど、外部のサイトからある URL に移動した場合は除きます。 None はサイト間リクエストの制限はありません。

### 参考 URL

https://qiita.com/kubocchi/items/020352173d014cbf5332

https://developer.mozilla.org/ja/docs/Glossary/Cookie

https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy

## hoge.com:8080 のクッキーは hoge.com:9090 にも送信されるか？

- 回答

送信できる。

- 回答根拠

Cookie はプロトコル、ポートは関係なく Domain で Cookie を送るかどうか判断するため。

Set-Cookie ヘッダーは、Domain のみで Cookie の送信先を判断するしている。

### 参考 URL

https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Set-Cookie

https://qiita.com/kubocchi/items/020352173d014cbf5332

## www.hoge.comで発行されたクッキーは、www.api.hoge.comにも送信されるか？

- 回答

送信できる。（"Domain=www.api.hoge.com"をしている前提）

- 回答根拠

Cookie の Domain 設定の仕様上、ドメインが指定された場合、すべてのサブドメインが常に含まれるため。

### 参考 URL

https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Set-Cookie

https://qiita.com/kubocchi/items/020352173d014cbf5332

## クッキーに Domain="hoge.com"を指定した場合、api.hoge.com にもクッキーは送信されるでしょうか？

- 回答

送信できる。

- 回答根拠

Cookie の Domain 設定の仕様上、ドメインが指定された場合、すべてのサブドメインが常に含まれるため。

### 参考 URL

https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Set-Cookie

https://qiita.com/kubocchi/items/020352173d014cbf5332

## JavaScript からクッキーの値が取得されることを防ぐことは可能でしょうか？どうすれば良いのでしょうか？

- 回答
  JavaScript から Cookie の値が取得されることを防ぐことは可能。
  抜本的な対策としては、異なるドメインやサブドメインを使うことで、同一オリジンポリシーを適用することです。
  保険的な対策としては、HTTPOnly クッキー属性を true にすることで、クライアント側スクリプトから参照できないようにすることです。

### 参考 URL

https://developer.mozilla.org/ja/docs/Web/API/Document/cookie

https://developer.mozilla.org/ja/docs/Mozilla/Add-ons/WebExtensions/API/cookies/Cookie

## HTTPS（暗号化）通信の時だけクッキーを送信することは可能でしょうか？

- 回答

可能です。Cookie 情報の secure 属性を true にすることで HTTPS（暗号化）通信の時だけ Cookie を送信できます。

### 参考 URL

https://developer.mozilla.org/ja/docs/Mozilla/Add-ons/WebExtensions/API/cookies/Cookie

## クッキーに Expires を設定すると、どのように挙動が変わるでしょうか？

Cookie に Expires を設定しない場合、Cookie の有効期限はセッションクッキーの寿命になります。
セッションはクライアントが終了した時に終了するので、Cookie はその時点で削除されます。

Cookie に Expires を設定した場合、Cookie の有効期限をタイムスタンプ形式で指定できます。
Cookie の有効期限はサーバー側ではなく、Cookie が設定されているクライアントからの相対時刻で設定されます。
ただし、Cookie に Expires と Max-Age の両方が設定されている場合、Max-Age が優先されます。

### 参考 URL

https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Set-Cookie

## SameSite 属性について説明してください

Cookie がオリジン間リクエストで送信されないことを主張することで、クロスサイトリクエストフォージェリ攻撃 (CSRF) を防ぐことが目的です。SameSite 属性はセキュリティレベルの高さの指定として、None(なし)、Lax(緩い)、Strict(厳しい)の値を指定できます。

セキュリティレベルの具体的な意味は以下のとおりです。

- Strict: ブラウザは same-site のリクエスト（つまり、クッキーを設定したのと同じサイトから発信されたリクエスト）に対してのみクッキーを送信します。リクエストが現在の URL とは異なる URL から発生した場合、SameSite=Strict 属性を持つクッキーは送信されません。

- Lax: 画像やフレームをロードするための呼び出しなどのクロスサイトサブリクエストではクッキーが抑止されますが、ユーザーがリンクをクリックするなどして外部サイトから URL に移動すると送信されます。

- None: ブラウザはクロスサイトと same-site の両方のリクエストでクッキーを送信します。

### 参考 URL

https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Set-Cookie

## クッキーに格納しない方が良い情報の例を、3 つ以上挙げてください

- 強度な暗号化処理がなされていないログインパスワード情報

- 銀行のパスワード情報

- クレジットカード情報

## クッキーを使うべきタイミングと、ローカルストレージを使うべきタイミングを挙げてみてください

Cookie は主にサーバー側を読み取るためのものであり、ローカルストレージはクライアント側でのみ読み取ることができます。

クライアント（JavaScript）の場合は、ローカルストレージに切り替えるべきです。
各 HTTP ヘッダーのすべてのデータを送信することにより、帯域幅を浪費しています。

### 参考 URL

https://www.1915keke.com/entry/2019/02/18/153826
https://stackoverflow.com/questions/3220660/local-storage-vs-cookies

## XSS（クロスサイトスクリプティング）により、他ユーザのクッキー情報が抜き出される仕組みを説明してください。どのような対策が考えられますか？

### XSS（クロスサイトスクリプティング）により、他ユーザのクッキー情報が抜き出される仕組みについて

1. 悪意のある第三者が罠を仕掛ける
   1.a 悪意のある第三者が罠 Web ページを用意する
   1.b 悪意のある第三者が罠リンクを含むメールを用意する
2. 利用者が罠とは知らず閲覧する。
   2.a 利用者が罠とは知らず悪意のあるサイト罠 Web ページを閲覧する
   2.b 利用者が罠とは知らず罠リンクを含むメールをクリックする。
3. 利用者のブラウザまたはメーラーからスクリプトを含む文字列を WEB 掲示板サービスに対して送信
4. WEB 掲示板サービスはスクリプトを含む Web ページを出力
5. 利用者のブラウザ上でスクリプトが実行
6. 悪意のある第三者がスクリプトの内容によって Cookie 情報が漏洩

### XSS（クロスサイトスクリプティング）の対策

クロスサイト・スクリプティングの脆弱性への対策は、ウェブアプリケーションの性質に合わせ、下記の 3 つに分類しています。

1)　 HTML テキストの入力を許可しない場合の対策 2)　 HTML テキストの入力を許可する場合の対策 3)　全てのウェブアプリケーションに共通の対策

1. に該当するウェブアプリケーションの例には、検索機能や個人情報の登録等、HTML タグ等を用いた入力を許可する必要がないものが挙げられます。多くのウェブアプリケーションがこちらに該当するはずです。

2. に該当するウェブアプリケーションの例には、自由度の高い掲示板やブログ等が挙げられます。たとえば、利用者が入力文字の色やサイズを指定できる機能等を実装するために、HTML テキストの入力を許可する場合があるかもしれません。

3. は、1)、2) の両者のウェブアプリケーションに共通して必要な対策です。

#### 1) HTML テキストの入力を許可しない場合の対策

##### 根本的解決策

- ウェブページに出力する全ての要素に対して、エスケープ処理を施す。

- URL を出力するときは、「http://」や 「https://」で始まる URL のみを許可する。

- <script>...</script> 要素の内容を動的に生成しない。

- スタイルシートを任意のサイトから取り込めるようにしない。

##### 保険的対策

- 入力値の内容チェックを行う。

#### 2) HTML テキストの入力を許可する場合の対策

##### 根本的解決策

- 入力された HTML テキストから構文解析木を作成し、スクリプトを含まない必要な要素のみを抽出する

##### 保険的対策

- 入力された HTML テキストから、スクリプトに該当する文字列を排除する。

#### 3)　全てのウェブアプリケーションに共通の対策

##### 根本的解決策

- HTTP レスポンスヘッダの Content-Type フィールドに文字コード（charset）を指定する。

##### 保険的解決策

- Cookie 情報の漏えい対策として、発行する Cookie に HttpOnly 属性を加え、TRACE メソッドを無効化する。

- クロスサイト・スクリプティングの潜在的な脆弱性対策として有効なブラウザの機能を有効にするレスポンスヘッダを返す。

#### 参考 URL

https://www.ipa.go.jp/security/vuln/websecurity-HTML-1_5.html

## Cookie に関するクイズ

Q1. Cookie を利用することで Web サイトのアクセス解析が可能です。具体的に取得できる値として以下の選択肢から最も適切なものを選択してください。

A) 一定期間に訪問したユニーク数ユーザー数
B) ページ遷移数
C) セッション数の遷移
D) A〜C のすべて取得できる値である

Q2. 2018 年から Cookie の使用意図や管理方法などをユーザーに伝えるように定める法規制が制定されている。  
この法規制の名称について以下の選択肢から選択してください。

A) GDPR
B) GAFA
C) GODIVA

Q3.Web サイトまたは Web サービスを開発する際、Cookie に関する取り扱いはどこに記載すべきですか？以下の選択肢から選択してください。

A) 利用規約
B) プライバシーポリシー
C) 特定商取引法に基づく表記
